# üöÄ Deployment Guide - Render Platform

This guide will help you deploy your FastAPI Payment Service to Render.

## üìã Prerequisites

1. **Render Account**: Sign up at [render.com](https://render.com)
2. **GitHub Repository**: Push your code to GitHub
3. **Paystack Account**: Get your API keys from [paystack.com](https://paystack.com)

## üõ†Ô∏è Deployment Steps

### Step 1: Prepare Your Repository

1. **Push to GitHub**:
   ```bash
   git add .
   git commit -m "Add deployment configuration"
   git push origin main
   ```

### Step 2: Deploy on Render

#### Option A: Using render.yaml (Recommended)

1. **Connect Repository**:
   - Go to [render.com/dashboard](https://render.com/dashboard)
   - Click "New +" ‚Üí "Blueprint"
   - Connect your GitHub repository
   - Render will automatically detect `render.yaml`

2. **Environment Variables**:
   - Set the following in Render dashboard:
     ```
     PAYSTACK_SECRET_KEY=sk_live_your_secret_key
     PAYSTACK_PUBLIC_KEY=pk_live_your_public_key
     SECRET_KEY=your-super-secret-key-here
     DEBUG=false
     ENVIRONMENT=production
     RENDER=true
     ```

#### Option B: Manual Setup

1. **Create Web Service**:
   - Go to [render.com/dashboard](https://render.com/dashboard)
   - Click "New +" ‚Üí "Web Service"
   - Connect your GitHub repository

2. **Configure Service**:
   ```
   Name: fastapi-payment-service
   Environment: Python 3
   Build Command: pip install -r requirements.txt
   Start Command: uvicorn app.main:app --host 0.0.0.0 --port $PORT
   ```

3. **Set Environment Variables** (same as above)

### Step 3: Database Setup (Optional)

For production, consider using PostgreSQL:

1. **Create Database**:
   - Go to "New +" ‚Üí "PostgreSQL"
   - Choose "Free" plan
   - Note the connection details

2. **Update Environment Variables**:
   ```
   DATABASE_URL=postgresql://user:password@host:port/database
   ```

3. **Run Migrations**:
   ```bash
   # Add to your build command
   alembic upgrade head
   ```

### Step 4: Configure Webhooks

1. **Update Paystack Webhook**:
   - Go to Paystack Dashboard ‚Üí Settings ‚Üí Webhooks
   - Add webhook URL: `https://your-app-name.onrender.com/webhook/paystack`
   - Select events: `charge.success`, `charge.failed`

## üîß Configuration Files

### render.yaml
```yaml
services:
  - type: web
    name: fastapi-payment-service
    env: python
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PAYSTACK_SECRET_KEY
        sync: false
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: false
```

### Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `PAYSTACK_SECRET_KEY` | Paystack secret key | `sk_live_...` |
| `PAYSTACK_PUBLIC_KEY` | Paystack public key | `pk_live_...` |
| `SECRET_KEY` | App secret key | Generated by Render |
| `DEBUG` | Debug mode | `false` |
| `DATABASE_URL` | Database URL | Auto-generated |
| `ALLOWED_ORIGINS` | CORS origins | Your domain |

## üê≥ Docker Deployment (Alternative)

If you prefer Docker:

1. **Enable Docker**:
   - In Render dashboard, set "Dockerfile Path" to `./Dockerfile`

2. **Dockerfile Features**:
   - Multi-stage build
   - Non-root user
   - Health checks
   - Optimized for production

## üìä Monitoring & Logs

### Health Checks
- **Endpoint**: `https://your-app.onrender.com/health`
- **Response**: `{"status": "ok", "service": "FastAPI Payment Service"}`

### Logs
- Access logs in Render dashboard
- Monitor for errors and performance
- Set up alerts for failures

### Metrics
- Response times
- Error rates
- Memory usage
- CPU usage

## üîí Security Checklist

- [ ] Use HTTPS (automatic on Render)
- [ ] Set strong SECRET_KEY
- [ ] Use production Paystack keys
- [ ] Configure CORS properly
- [ ] Enable webhook signature verification
- [ ] Set DEBUG=false
- [ ] Use environment variables for secrets

## üö® Troubleshooting

### Common Issues

1. **Build Failures**:
   ```bash
   # Check build logs
   # Ensure all dependencies are in requirements.txt
   ```

2. **Environment Variables**:
   ```bash
   # Verify all required variables are set
   # Check variable names match config.py
   ```

3. **Database Connection**:
   ```bash
   # Check DATABASE_URL format
   # Ensure database is accessible
   ```

4. **Paystack Integration**:
   ```bash
   # Verify API keys are correct
   # Check webhook URL configuration
   ```

### Debug Commands

```bash
# Check application status
curl https://your-app.onrender.com/health

# Test payment endpoint
curl -X POST https://your-app.onrender.com/payments/initiate \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=test@example.com&amount=1000"
```

## üìà Performance Optimization

1. **Enable Caching**:
   - Add Redis for session storage
   - Cache Paystack responses

2. **Database Optimization**:
   - Add database indexes
   - Use connection pooling

3. **Static Files**:
   - Use CDN for static assets
   - Optimize images and CSS

## üîÑ CI/CD Pipeline

Set up automatic deployments:

1. **Auto-Deploy**: Enable in Render dashboard
2. **Branch Protection**: Use main branch only
3. **Testing**: Add pre-deployment tests
4. **Rollback**: Keep previous versions ready

## üìû Support

- **Render Documentation**: [render.com/docs](https://render.com/docs)
- **FastAPI Documentation**: [fastapi.tiangolo.com](https://fastapi.tiangolo.com)
- **Paystack Documentation**: [paystack.com/docs](https://paystack.com/docs)

---

**Your FastAPI Payment Service is now ready for production! üéâ**
